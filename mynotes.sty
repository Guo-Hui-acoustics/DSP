% mynotes.sty - 我的个人笔记样式文件 
% 维护者: Guo-Hui-acoustics
% 更新时间: 2025/11/30

% ==================================================
% 0. 文件标识
% ==================================================
    \NeedsTeXFormat{LaTeX2e}
    \ProvidesPackage{mynotes}[2025/11/30 My Personal Notes Style Refactored]


% ==================================================
% 1. 常用宏包
% ==================================================
    % 1.1 数学支持
    \usepackage{amsmath}
    \usepackage{amssymb}
    \usepackage{empheq}
    \usepackage{arydshln} 

    % 1.2 图形与颜色支持
    \usepackage{graphicx}
    \usepackage{float}
    \usepackage{subcaption}
    \usepackage[table]{xcolor} 
    \definecolor{lightblue}{rgb}{0.2, 0.4, 0.8} 
    \definecolor{bg}{rgb}{0.16, 0.16, 0.18} 
    \usepackage{tcolorbox}
    % 定义一个全局的图片外框样式 "figurebox"
    % colframe: 边框颜色 (gray!50 表示 50% 灰度，淡雅一些)
    % colback: 背景颜色 (white)
    % arc: 圆角半径 (10pt)
    % boxrule: 边框粗细 (1pt)
    % boxsep: 内容与边框的额外间距
    \tcbset{figurebox/.style={
        colframe=gray!50,
        colback=white,
        arc=10pt,
        boxrule=1pt,
        boxsep=5pt,
        width=\linewidth
    }}

    % 1.3 实用工具
    \usepackage{lipsum} 
    \usepackage{calc}   
    \usepackage{enumitem}


% ==================================================
% 2. 页面布局
% ==================================================
    \usepackage[a4paper, top=2.54cm, bottom=2.54cm, left=1.91cm, right=1.91cm]{geometry}
    \usepackage{setspace}
    \setstretch{1.5} % 全局 1.5 倍行距 (包括目录)
    \usepackage{indentfirst} % 首行缩进
    \setlength{\parindent}{2em}


% ==================================================
% 3. 字体配置
% ==================================================
    % 3.1 西文字体
    \usepackage[T1]{fontenc}
    \usepackage{newtxtext} 
    % 3.2 中文支持
    % scheme=plain: 不更改默认的字号和版式，只提供中文支持
    % fontset=fandol: 使用 Fandol 开源字体
    \usepackage[scheme=plain, fontset=fandol]{ctex}
    


% ==================================================
% 4. 多级标题配置
% ==================================================
\usepackage{titlesec}

    % 4.0 箴言 (Epigraph) 功能支持

    % 使用 \gdef 初始化，确保它和 \empty 类型一致(短宏)
    % 这样 \ifx 判断才会准确，消除目录页的"幽灵标点"
    \gdef\@notechapterquote{}
    \gdef\@notechapterauthor{}

    % 用户接口：设置当前章节的箴言
    \newcommand{\setchapterquote}[2]{%
        \gdef\@notechapterquote{#1}%
        \gdef\@notechapterauthor{#2}%
    }

    % 内部辅助命令：打印并清空箴言
    \newcommand{\@printchapterquote}{%
        \ifx\@notechapterquote\empty
            % 为空则不操作
        \else
            % 有内容则排版
            \par\nointerlineskip
            \vspace{0.5em} 
            \hfill 
            \begin{minipage}{0.7\linewidth} 
                \raggedleft 
                \small
                % 打印箴言
                \textbf{\texttt{``\@notechapterquote''}}
                % 换行并打印作者
                \par\vspace{0.5ex}
                \textbf{\texttt{--- \@notechapterauthor}}
            \end{minipage}
            \par
            % 打印后立即清空
            \gdef\@notechapterquote{}%
            \gdef\@notechapterauthor{}%
        \fi
    }

    % 4.1 有编号一级标题 (Numbered Section) -> Chapter 样式 + 箴言钩子
    % 只有带编号的标题(如 Chapter 1)才会触发箴言逻辑
    \titleformat{\section}
        {\Large\bfseries}       
        {Chapter\ \thesection}  
        {1em}                   
        {}                      
        [\@printchapterquote]   

    \titlespacing*{\section}{0pt}{3.5ex plus 1ex minus .2ex}{2.3ex plus .2ex}


    % 4.2 无编号一级标题 (Numberless Section) -> 保护目录页
    % 【关键修改 2】显式定义无编号标题(如目录、前言)的格式
    % 这种格式下不挂载 [\@printchapterquote]，彻底杜绝干扰
    \titleformat{name=\section, numberless}
        {\Large\bfseries}
        {}
        {0pt}
        {}
    
    \titlespacing*{name=\section, numberless}{0pt}{3.5ex plus 1ex minus .2ex}{2.3ex plus .2ex}


    % 4.3 二级标题 (Subsection)
    \titleformat{\subsection}
        {\large\bfseries}
        {\thesubsection}
        {1em}
        {}
    \titlespacing*{\subsection}{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}


    % 4.4 三级标题 (Subsubsection)
    \titleformat{\subsubsection}
        {\normalsize\bfseries}
        {\thesubsubsection}
        {1em}
        {}
    \titlespacing*{\subsubsection}{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}


% ==================================================
% 5. 交叉引用配置
% ==================================================
    \usepackage{nameref}
    \usepackage{hyperref} 
    \hypersetup{
        colorlinks=true, 
        linkcolor=blue, 
        citecolor=green, 
        urlcolor=cyan, 
        linkbordercolor={1 1 1},
    }
    \renewcommand{\eqref}[1]{\hyperref[#1]{\textup{\tagform@{\ref*{#1}}}}}


% ==================================================
% 6. 页眉和页脚配置
% ==================================================
    \usepackage{fancyhdr}
    \usepackage{lastpage}


% ==================================================
% 7. 绘图相关
% ==================================================
    \usepackage{tikz}
    \usepackage{pgfplots}
    \pgfplotsset{compat=1.18}
    \usepgfplotslibrary{groupplots}
    \usetikzlibrary{tikzmark, fit, positioning, arrows.meta, shapes.geometric, calc}


% ==================================================
% 8. 封面页定制
% ==================================================
    % 8.1 信息配置命令
    \newcommand{\notetitle}[1]{\def\@notetitle{#1}}
    \newcommand{\noteauthor}[1]{\def\@noteauthor{#1}}
    \newcommand{\notedate}[1]{\def\@notedate{#1}}
    \newcommand{\noteversion}[1]{\def\@noteversion{#1}}
    \newcommand{\noterepo}[1]{\def\@noterepo{#1}}
    \newcommand{\noteemail}[1]{\def\@noteemail{#1}}

    % 默认元数据
    \def\@notetitle{Untitled Notes}
    \def\@noteauthor{Unknown Author}
    \def\@notedate{\today}
    \def\@noteversion{v1.0}
    \def\@noterepo{https://github.com}
    \def\@noteemail{example@email.com}

    % 8.2 封面图像配置
    % 定义设置接口
    \newcommand{\setcoverimage}[1]{\def\@coverimage{#1}}

    % 设置默认逻辑：尝试加载 dsp_cover_image.tex
    \IfFileExists{dsp_cover_image.tex}{
        % 存在则加载 (TikZ 代码自包含 savebox 定义)
        \def\@coverimage{\input{dsp_cover_image.tex}}
    }{
        % 不存在则显示占位符
        \def\@coverimage{%
            \fbox{\parbox{10cm}{\centering 
            \vspace{1cm} 
            \textbf{File missing: dsp\_cover\_image.tex} \\
            Please create it or use \texttt{\textbackslash setcoverimage}.
            \vspace{1cm}
            }}%
        }
    }

    % 8.3 封面生成主命令
    \newcommand{\makenotetitle}{
        \begin{titlepage}
            \centering
            % 顶部弹性空间
            \vspace*{\stretch{1}}
            
            % 1. 标题
            {\Huge \@notetitle \footnotemark[1] \par}
            
            % [距离 1] 标题基线 -> 上横线 = 0.3cm
            % \nointerlineskip: 忽略行间距，确保 vspace 从文字底部几何边缘开始计算
            \par\nointerlineskip 
            \vspace{0.5cm}
            
            % 2. 上横线
            \noindent\rule{\linewidth}{2pt}
            
            % [距离 2] 上横线 -> 图形顶部 = 0.3cm
            \par\nointerlineskip
            \vspace{0.5cm}
            
            % 3. 封面图像区域
            % 使用大括号 {} 限制范围，\centering 居中
            % 这种方式不产生 center 环境的额外垂直间距
            {
                \centering
                \@coverimage 
                \par
            }
            
            % [距离 3] 图形底部 -> 下横线 = 0.3cm
            \par\nointerlineskip
            \vspace{0.5cm}
            
            % 4. 下横线
            \noindent\rule{\linewidth}{2pt}
            
            % [距离 4] 下横线 -> 作者信息顶部 = 0.3cm
            \par\nointerlineskip
            \vspace{0.1cm}
            
            % 5. 作者与版本信息 (右对齐)
            \begin{flushright}
                {\large \textbf{\@noteauthor} \footnotemark[2] \par}
                {\small \texttt{\@noteversion} \par}
            \end{flushright}
            
            % 底部弹性空间
            \vspace*{\stretch{2}}
            
            % 6. 脚注
            \footnotetext[1]{Project repository: \url{\@noterepo}}
            \footnotetext[2]{Author email: \href{mailto:\@noteemail}{\@noteemail}}
            
        \end{titlepage}
        \setcounter{footnote}{0}
    }


% ==================================================
% 9. 前言定制 (Preface)
% ==================================================
    % 9.1 定义变量
    \newcommand{\notepreface}[1]{\def\@notepreface{#1}}

    % 9.2 生成前言页主命令
    \newcommand{\makepreface}{
        \clearpage
        % 1. 切换页码为大写罗马数字 (I, II, III...)
        % 如果想要小写 (i, ii...), 请改为 \pagenumbering{roman}
        \pagenumbering{Roman}
        
        % 2. 强制设定页码为 2 (II)
        % 逻辑：封面由于 titlepage 环境通常被视为第 1 页(尽管不显示)
        \setcounter{page}{2}
        
        % 3. 页面样式设置
        % 使用 fancy 样式以显示页眉页脚，或者用 plain (页码在底部)
        %\thispagestyle{fancy}
        
        % 4. 添加到目录 (关键步骤)
        % \phantomsection 配合 hyperref 确保点击目录能准确跳转到当前页顶部
        \phantomsection 
        \addcontentsline{toc}{section}{Preface}
        
        % 5. 绘制标题
        \noindent{\Large\bfseries Preface\par}
        
        % 标题与内容的间距 (与正文标题间距保持视觉一致)
        \vspace{1em} 
        
        % 6. 渲染内容
        \@notepreface
        
        \clearpage
        % 注意：此时页码依然是罗马数字。
        % 通常在 main.tex 中，目录结束后才手动切换回阿拉伯数字 (arabic)。
    }


% ==================================================
% 10. 自定义命令
% ==================================================
    % 10.1 单图插入 (带圆角边框)
    \newcommand{\insertsingleimage}[3]{
        \begin{figure}[H]
            \centering
            % 使用定义的 figurebox 样式包裹内容
            \begin{tcolorbox}[figurebox]
                \centering
                % 图片
                \includegraphics[width=0.7\textwidth]{#1}
                % 标题 (自动在框内)
                \caption{#2}
                \label{#3}
            \end{tcolorbox}
        \end{figure}
    }

    % 10.2 双图横排插入 (带圆角边框)
    \newcommand{\insertdoubleimage}[8]{
        \begin{figure}[H]
            \centering
            \begin{tcolorbox}[figurebox]
                \centering
                \begin{subfigure}[b]{0.48\textwidth}
                    \centering
                    \includegraphics[width=\textwidth]{#1}
                    \caption{#2}
                    \label{#3}
                \end{subfigure}
                \hfill
                \begin{subfigure}[b]{0.48\textwidth}
                    \centering
                    \includegraphics[width=\textwidth]{#4}
                    \caption{#5}
                    \label{#6}
                \end{subfigure}
                % 总标题
                \caption{#7}
                \label{#8}
            \end{tcolorbox}
        \end{figure}
    }

    % 10.3 tikz插入 (带圆角边框)
    \newcommand{\inserttikzpicture}[3]{
        \begin{figure}[H]
            \centering
            \begin{tcolorbox}[figurebox]
                \centering
                % TikZ 图形
                \begin{tikzpicture}[scale=1.2, font=\small]
                    #1
                \end{tikzpicture}
                \caption{#2}
                \label{#3}
            \end{tcolorbox}
        \end{figure}
    }

    % 10.4 表格插入 (保持原样，通常表格不需要圆角框，如需要也可加)
    \newcommand{\inserttable}[4]{
        \begin{table}[H]
            \centering
            \caption{#3}
            \label{#4}
            \begin{tabular}{#1}
                \hline \hline
                #2 \\
                \hline \hline
            \end{tabular}
        \end{table}
    }

    % 10.5 代码块插入
    \usepackage{minted}
    \setminted{frame=single, framesep=2mm, fontsize=\small, breaklines, tabsize=4, python3=true}
    \newcommand{\insertcodefromfile}[4]{
        \begin{figure}[H]
            \centering
            \inputminted{#1}{#2}
            \caption{#3}
            \label{#4}
        \end{figure}
    }

    % 10.6 正文紧凑多级列表
    % 创建一个新的列表环境 textenum，最大深度 3
    \newlist{textenum}{enumerate}{3}
        % 全局设置：nosep (消除所有垂直间距)
        \setlist[textenum]{nosep}
        % 第一级配置: 序号缩进 2em (与正文段首对齐)
        % leftmargin=*: 让 LaTeX 自动计算文字需要往后推多少距离
        \setlist[textenum,1]{label=(\arabic*), labelindent=2em, leftmargin=*}
        % 第二级配置: 序号缩进 4em
        \setlist[textenum,2]{label=(\alph*), labelindent=4em, leftmargin=*}
        % 第三级配置: 序号缩进 6em
        \setlist[textenum,3]{label=\roman*., labelindent=6em, leftmargin=*}


%% 在此命令前增加新的命令
\endinput